# Database Schema Update: Certificates and Offer Letters

## Summary
Added two new tables to store certificate and offer letter records in the database.

## Tables Created

### 1. `certificates` Table
Stores information about all generated certificates.

**Columns:**
- `id` - Primary key (auto-increment)
- `application_id` - Foreign key to applications table
- `user_id` - Foreign key to users table
- `internship_id` - Foreign key to internships table
- `filename` - Certificate file name (e.g., certificate_5_1_1766816356.html)
- `file_path` - Full path to certificate file (e.g., public/certificates/...)
- `generated_by` - Admin user ID who generated the certificate
- `generated_at` - Timestamp when certificate was generated
- `created_at` - Record creation timestamp

**Relationships:**
- Each certificate is linked to one application
- Each certificate is linked to one user (student)
- Each certificate is linked to one internship
- Each certificate is generated by one admin user

### 2. `offer_letters` Table
Stores information about all generated offer letters.

**Columns:**
- `id` - Primary key (auto-increment)
- `application_id` - Foreign key to applications table
- `user_id` - Foreign key to users table
- `internship_id` - Foreign key to internships table
- `filename` - Offer letter file name (e.g., offer_letter_5_1_1766816356.html)
- `file_path` - Full path to offer letter file (e.g., public/offer-letters/...)
- `generated_by` - Admin user ID who generated the offer letter
- `generated_at` - Timestamp when offer letter was generated
- `created_at` - Record creation timestamp

**Relationships:**
- Each offer letter is linked to one application
- Each offer letter is linked to one user (student)
- Each offer letter is linked to one internship
- Each offer letter is generated by one admin user

## Code Changes

### 1. `admin/sections/certificates.php`
**Changes made:**
- Added database record insertion when certificate is generated
- Gets the application_id from user_id and internship_id
- Stores filename, file path, admin user ID, and generation timestamp
- Records are inserted into the `certificates` table

**New code added (lines 180-191):**
```php
// Get application_id for the user and internship
$app_result = $conn->query("SELECT id FROM applications WHERE user_id=$user_id AND internship_id=$internship_id");
if($app_result->num_rows > 0) {
    $app = $app_result->fetch_assoc();
    $app_id = $app['id'];
    $admin_id = $_SESSION['user_id'];
    $generated_at = date('Y-m-d H:i:s');
    $file_path = 'public/certificates/' . $filename;
    
    // Save certificate record to database
    $conn->query("INSERT INTO certificates (application_id, user_id, internship_id, filename, file_path, generated_by, generated_at) 
                 VALUES ($app_id, $user_id, $internship_id, '$filename', '$file_path', $admin_id, '$generated_at')");
}
```

### 2. `admin/sections/offer-letters.php`
**Changes made:**
- Added database record insertion when offer letter is generated
- Gets the application_id from user_id and internship_id
- Stores filename, file path, admin user ID, and generation timestamp
- Records are inserted into the `offer_letters` table

**New code added (lines 199-210):**
```php
// Get application_id for the user and internship
$app_result = $conn->query("SELECT id FROM applications WHERE user_id=$user_id AND internship_id=$internship_id");
if($app_result->num_rows > 0) {
    $app = $app_result->fetch_assoc();
    $app_id = $app['id'];
    $admin_id = $_SESSION['user_id'];
    $generated_at = date('Y-m-d H:i:s');
    $file_path = 'public/offer-letters/' . $filename;
    
    // Save offer letter record to database
    $conn->query("INSERT INTO offer_letters (application_id, user_id, internship_id, filename, file_path, generated_by, generated_at) 
                 VALUES ($app_id, $user_id, $internship_id, '$filename', '$file_path', $admin_id, '$generated_at')");
}
```

## How to Apply Changes

### Option 1: Run Migration SQL
Execute the migration file in phpMyAdmin:
1. Open phpMyAdmin
2. Select the `digital_tarai` database
3. Go to SQL tab
4. Copy and paste the contents of `migrations/001_add_certificates_and_offer_letters.sql`
5. Click Execute

### Option 2: Use MySQL Command Line
```bash
mysql -u root -p digital_tarai < migrations/001_add_certificates_and_offer_letters.sql
```

## Benefits

✅ **Track Certificate Generation**: Know exactly when and who generated each certificate
✅ **Track Offer Letter Generation**: Know exactly when and who generated each offer letter
✅ **Audit Trail**: Complete history of all documents generated
✅ **Database Integrity**: Foreign keys ensure referential integrity
✅ **Query Reports**: Can easily generate reports of issued certificates/offer letters
✅ **Frontend Display**: Can now display certificates and offer letters on the frontend by querying these tables

## Next Steps

After applying these tables, you can:
1. Display a list of issued certificates on the admin dashboard
2. Show student history of all generated certificates and offer letters
3. Create reports for compliance and audit purposes
4. Track which admin generated each document
5. Generate statistics about certificate/offer letter issuance

